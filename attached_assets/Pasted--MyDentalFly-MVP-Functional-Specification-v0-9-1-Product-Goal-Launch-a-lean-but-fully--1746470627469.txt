# MyDentalFly â€“ MVP Functional Specification (v0.9)

---
## 1Â Â Product Goal
Launch a lean but fully usable dentalâ€‘travel booking platform that lets prospects:
1. Compare indicative treatment pricing across verified clinics.
2. Build a personalised quote via a guided 6â€‘step wizard (incl. dental chart).
3. Register/Login to a secure **Patient Portal** to message the chosen clinic and upload records.
4. (Admin) View leads & treatment plans in a backâ€‘office dashboard.

> **Timeâ€‘box**:  âŒšÂ 2Â weeks to public beta.

---
## 2Â Â User Stories
| ID | As a â€¦ | I want to â€¦ | So that â€¦ |
|----|---------|-------------|-----------|
| U1 | Visitor | search by city + date | I can see clinics that match my travel window |
| U2 | Visitor | step through a quote wizard with layman explanations | I understand treatments & build confidence |
| U3 | Visitor | mark specific teeth on a chart | the quote reflects my exact needs |
| U4 | Visitor | receive a results list sorted by relevance | I can pick the best clinic quickly |
| U5 | Visitor | create an account & message my chosen clinic | we can finalise a treatment plan |
| U6 | Clinic | view incoming quotes with patient details | I can reply with an accurate proposal |
| U7 | Admin  | see all quotes, users & clinics in one panel | our team can manage the funnel |
| U8 | Visitor | click a **Special Offer** and have it respected endâ€‘toâ€‘end | I get the deal I selected |

---
## 3Â Â Information Architecture & Routes
| Route | Component Tree (topÂ ğŸ ’ leaf) | Auth? |
|-------|-------------------------------|------|
| `/` (Home) | `HeroSearch` / `SpecialOffersCarousel` / `PopularClinics` / `Packages` | No |
| `/quote` | `QuoteWizard` (6Â steps)<br>Â Â â€“ `GeneralForm`<br>Â Â â€“ `DentalChart`<br>Â Â â€“ `TreatmentPicker` | No |
| `/results` | `ClinicResults` â†’ `ClinicCard` | No |
| `/portal` | `AuthGate` â†’ `PatientDashboard` | Yes (Patient) |
| `/admin` | `AuthGate` â†’ `AdminPanel` | Yes (Admin) |

---
## 4Â Â DataÂ Model (Postgres via Supabase)
### 4.1 Tables
```mermaid
erDiagram
    patients ||--o{ quotes : makes
    clinics  ||--o{ quotes : receives
    quotes   ||--o{ quote_items : has
    quotes   ||--o{ messages : has
    special_offers ||--o{ quotes : may_apply
```

| Table | Core Fields |
|-------|-------------|
| **patients** | `id` PK, `name`, `email`, `phone`, `password_hash`, `created_at` |
| **clinics** | `id` PK, `name`, `city`, `rating`, `price_band`, `features` (JSON), `is_promoted` |
| **special_offers** | `id` PK, `clinic_id` FK, `title`, `summary`, `badge_colour`, `start`, `end`, `payload` (JSON) |
| **quotes** | `id` PK, `patient_id` FK, `selected_clinic_id` FK NULL, `status` (draft/submitted/accepted), `created_at` |
| **quote_items** | `id` PK, `quote_id` FK, `treatment_code`, `quantity`, `unit_price_est` |
| **messages** | `id` PK, `quote_id` FK, `sender_role` (patient/clinic/admin), `body`, `created_at` |

---
## 5Â Â Business Logic
### 5.1 Quote Wizard
* Saves progress locally (localStorage) + remotely if loggedâ€‘in.
* Price table for treatments fetched from `/api/prices?city={city}` (cached 1Â day).

### 5.2 Results Ranking
1. If the visitor arrived from **Special Offer IDÂ X**, surface `clinic_id` linked to that offer at indexÂ 0.
2. Remaining clinics ordered by composite score *(rating Ã—Â (1Â â€“ price_percentile))*.

### 5.3 Special Offer Integration
| Step | Behaviour |
|------|-----------|
| 1ï¸âƒ£Â Click on `SpecialOfferCard` | Store `offer_id` in `sessionStorage.offer` and prefill `search.city = offer.city`. Navigate to `/quote`. |
| 2ï¸âƒ£Â Quote wizard | Normal flow. No UI change. |
| 3ï¸âƒ£Â Results page | Hook sorts clinic list per 5.2 and renders `ClinicCard.SpecialOfferBadge` (title + â€œSave 20%â€) on that first card. |
| 4ï¸âƒ£Â Select clinic | In `POST /api/quotes`, include `offer_id`. Backâ€‘end: create `quote_items` rows specified by `special_offers.payload`. |
| 5ï¸âƒ£Â Patient Portal | Treatment list shows the offer items flagged with a ğŸ icon. |
| 6ï¸âƒ£Â Clinic Dashboard | Quote has `special_offer_id` so staff can honour it in the final plan. |
| 7ï¸âƒ£Â Expiry | Nightly cron marks `special_offers` expired; frontâ€‘end hides expired offers. |

Edgeâ€‘Cases:
* Offer clicked **after** a partial quote already exists â†’ prompt â€œApply offer to current plan?â€
* Offer requires min treatment quantity â†’ validate in backâ€‘end before saving quote.

---
## 6Â Â Environment Variables (Replit â Secrets Manager)
| Key | Description |
|-----|-------------|
| `SUPABASE_URL` / `SUPABASE_ANON_KEY` | DB + Auth gateway |
| `MAILJET_API_KEY` / `MAILJET_SECRET` | Transactional emails |
| `STRIPE_SECRET_KEY` | Future payments (PhaseÂ 2) |
| `JWT_SECRET` | API auth between front & back end |

_Nothing else gets added until PhaseÂ 2._

---
## 7Â Â Nonâ€‘Functional Requirements
* **Performance**: LCP <Â 2Â s on 3G for `/` & `/quote`.
* **Security**: Supabase Rowâ€‘Levelâ€‘Security active; no public bucket for records.
* **GDPR**: user can delete account & files from portal.
* **WCAGÂ AA** colour & contrast.

---
## 8Â Â Definition of Done
1. All user stories U1â€‘U8 demoâ€‘able on staging.
2. `npm run test` passes â‰¥Â 90% statements covered.
3. `docker build . && docker run â€¦` serves prod build without crash.
4. Replit preview + custom domain respond **200** for routes listed in Â§3.
5. Smoke checklist signed off (see `/docs/99_release_checklist.md`).

---
## 9Â Â PhaseÂ 2 Backlog (postâ€‘launch)
* Multiâ€‘currency & locale switching
* AI image generation for missing clinic photos
* CRUD UI for Special Offers & Packages in Admin panel
* Payment capture (Â£200 deposit) via Stripe
* CRM webhooks â†’ HubSpot

---
Â©Â 2025Â MyDentalFly

