{% extends "base.html" %}

{% block title %}Dental Treatment Quote Builder - MyDentalFly{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quote-builder.css') }}">
<style>
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
    }
    .step:not(:last-child):after {
        content: '';
        position: absolute;
        background-color: #e5e7eb;
        height: 2px;
        width: 100%;
        top: 20px;
        left: 50%;
        z-index: 0;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        position: relative;
        z-index: 1;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    .step.active .step-number {
        background-color: #2563eb;
        color: white;
    }
    .step.completed .step-number {
        background-color: #10b981;
        color: white;
    }
    .step.completed:not(:last-child):after {
        background-color: #10b981;
    }
    .step-title {
        font-size: 0.875rem;
        color: #6b7280;
    }
    .step.active .step-title {
        color: #2563eb;
        font-weight: 600;
    }
    .step.completed .step-title {
        color: #10b981;
        font-weight: 600;
    }
    .treatment-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .treatment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .treatment-card.selected {
        border-color: #2563eb;
        background-color: #eff6ff;
    }
    .promo-badge {
        background-color: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }
    .promo-badge svg {
        width: 16px;
        height: 16px;
        margin-right: 0.25rem;
    }
    .quote-summary {
        background-color: #f9fafb;
        border-radius: 0.5rem;
        padding: 1.5rem;
    }
    .summary-total {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
    }
    .summary-savings {
        font-size: 1rem;
        font-weight: 600;
        color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white py-8">
    <div class="container mx-auto px-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Build Your Dental Treatment Quote</h1>
        
        <!-- Step Indicator -->
        <div class="step-indicator mb-8">
            <div class="step {% if step == 'dental-chart' %}active{% elif step_num > 1 %}completed{% endif %}">
                <div class="step-number">1</div>
                <div class="step-title">Dental Chart</div>
            </div>
            <div class="step {% if step == 'treatments' %}active{% elif step_num > 2 %}completed{% endif %}">
                <div class="step-number">2</div>
                <div class="step-title">Treatments</div>
            </div>
            <div class="step {% if step == 'promo-code' %}active{% elif step_num > 3 %}completed{% endif %}">
                <div class="step-number">3</div>
                <div class="step-title">Promo Code</div>
            </div>
            <div class="step {% if step == 'patient-info' %}active{% elif step_num > 4 %}completed{% endif %}">
                <div class="step-number">4</div>
                <div class="step-title">Your Info</div>
            </div>
            <div class="step {% if step == 'review' %}active{% elif step_num > 5 %}completed{% endif %}">
                <div class="step-number">5</div>
                <div class="step-title">Review</div>
            </div>
            <div class="step {% if step == 'confirmation' %}active{% endif %}">
                <div class="step-number">6</div>
                <div class="step-title">Confirmation</div>
            </div>
        </div>

        <!-- Conditional Step Content -->
        {% if step == 'dental-chart' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Interactive Dental Chart</h2>
            <p class="text-gray-600 mb-6">Click on teeth that require treatment. This helps us provide a more accurate quote tailored to your needs.</p>
            
            <div class="flex justify-center mb-8">
                <div id="dental-chart" class="border border-gray-200 rounded-lg p-4 w-full max-w-3xl">
                    <!-- Dental Chart SVG will be loaded here -->
                    <img src="{{ url_for('static', filename='images/dental-chart.svg') }}" alt="Interactive Dental Chart" class="w-full">
                </div>
            </div>
            
            <div class="flex justify-between">
                <button class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Skip</button>
                <button id="next-step" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Continue</button>
            </div>
        </div>
        
        {% elif step == 'treatments' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Select Your Treatments</h2>
            <p class="text-gray-600 mb-6">Choose the dental treatments you're interested in. You can select multiple options.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                {% for treatment in treatments %}
                <div class="treatment-card border border-gray-200 rounded-lg p-4 hover:border-blue-500" data-id="{{ treatment.id }}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-3">
                            <input type="checkbox" id="treatment-{{ treatment.id }}" name="treatments[]" value="{{ treatment.id }}" class="w-5 h-5 text-blue-600">
                        </div>
                        <div>
                            <label for="treatment-{{ treatment.id }}" class="block font-medium text-gray-800 mb-1">{{ treatment.name }}</label>
                            <p class="text-sm text-gray-600 mb-2">{{ treatment.description }}</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-blue-600">{{ treatment.price }}€</span>
                                {% if treatment.discount %}
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">{{ treatment.discount }}% off</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Special Treatment Packages</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {% for package in packages %}
                    <div class="treatment-card border border-gray-200 rounded-lg p-4 hover:border-blue-500" data-id="{{ package.id }}">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3">
                                <input type="checkbox" id="package-{{ package.id }}" name="packages[]" value="{{ package.id }}" class="w-5 h-5 text-blue-600">
                            </div>
                            <div class="w-full">
                                <div class="flex justify-between">
                                    <label for="package-{{ package.id }}" class="block font-medium text-gray-800 mb-1">{{ package.name }}</label>
                                    {% if package.badge %}
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ package.badge }}</span>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-gray-600 mb-2">{{ package.description }}</p>
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-bold text-blue-600">{{ package.price }}€</span>
                                        {% if package.original_price %}
                                        <span class="text-sm text-gray-500 line-through ml-2">{{ package.original_price }}€</span>
                                        {% endif %}
                                    </div>
                                    {% if package.savings %}
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Save {{ package.savings }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="flex justify-between">
                <button onclick="window.location.href='/quote-builder/dental-chart'" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Back</button>
                <button id="next-step" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Continue</button>
            </div>
        </div>
        
        {% elif step == 'promo-code' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Apply Promo Code</h2>
            <p class="text-gray-600 mb-6">If you have a promotional code, enter it below to get additional discounts on your quote.</p>
            
            <form id="promo-form" class="mb-8">
                <div class="flex flex-col md:flex-row md:items-end gap-4">
                    <div class="flex-grow">
                        <label for="promo-code" class="block text-sm font-medium text-gray-700 mb-1">Promo Code</label>
                        <input type="text" id="promo-code" name="promo-code" value="{{ promo_code }}" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your promo code">
                    </div>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">Apply Code</button>
                </div>
                
                {% if promo_code_status == 'valid' %}
                <div class="mt-3 flex items-center text-green-600">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Promo code applied successfully! You're saving {{ discount_amount }}€</span>
                </div>
                {% elif promo_code_status == 'invalid' %}
                <div class="mt-3 flex items-center text-red-600">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Invalid promo code. Please try again.</span>
                </div>
                {% endif %}
            </form>
            
            <div class="quote-summary mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Quote Summary</h3>
                <div class="space-y-2 mb-4">
                    {% for item in quote_items %}
                    <div class="flex justify-between">
                        <span>{{ item.name }}</span>
                        <span>{{ item.price }}€</span>
                    </div>
                    {% endfor %}
                </div>
                
                {% if discount_amount and discount_amount > 0 %}
                <div class="flex justify-between text-green-600 font-medium border-t border-b border-gray-200 py-2 my-2">
                    <span>Promo Discount</span>
                    <span>-{{ discount_amount }}€</span>
                </div>
                {% endif %}
                
                <div class="flex justify-between font-bold text-lg mt-2">
                    <span>Total</span>
                    <span class="summary-total">{{ total_price }}€</span>
                </div>
                
                {% if discount_amount and discount_amount > 0 %}
                <div class="text-right summary-savings mt-1">You save {{ discount_amount }}€</div>
                {% endif %}
            </div>
            
            <div class="flex justify-between">
                <button onclick="window.location.href='/quote-builder/treatments'" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Back</button>
                <button id="next-step" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Continue</button>
            </div>
        </div>
        
        {% elif step == 'patient-info' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Information</h2>
            <p class="text-gray-600 mb-6">Please provide your details so we can prepare a personalized quote.</p>
            
            <form id="patient-info-form" class="space-y-4 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="first-name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="first-name" name="first-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="last-name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="last-name" name="last-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country of Residence</label>
                    <select id="country" name="country" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select your country</option>
                        <option value="UK">United Kingdom</option>
                        <option value="US">United States</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="IT">Italy</option>
                        <option value="ES">Spain</option>
                        <option value="NL">Netherlands</option>
                        <option value="IE">Ireland</option>
                        <option value="BE">Belgium</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label for="travel-date" class="block text-sm font-medium text-gray-700 mb-1">Preferred Travel Date (approximate)</label>
                    <input type="date" id="travel-date" name="travel-date" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="additional-info" class="block text-sm font-medium text-gray-700 mb-1">Additional Information (optional)</label>
                    <textarea id="additional-info" name="additional-info" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Any specific concerns or requirements?"></textarea>
                </div>
                
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="consent" name="consent" type="checkbox" required class="w-4 h-4 text-blue-600 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="consent" class="text-gray-700">I agree to the <a href="/terms" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="/privacy" class="text-blue-600 hover:underline">Privacy Policy</a></label>
                    </div>
                </div>
            </form>
            
            <div class="flex justify-between">
                <button onclick="window.location.href='/quote-builder/promo-code'" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Back</button>
                <button id="next-step" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Continue</button>
            </div>
        </div>
        
        {% elif step == 'review' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Review Your Quote</h2>
            <p class="text-gray-600 mb-6">Please review your treatment quote before submitting.</p>
            
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Selected Treatments</h3>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    {% if quote_items %}
                    <div class="divide-y divide-gray-200">
                        {% for item in quote_items %}
                        <div class="py-3 flex justify-between">
                            <div>
                                <p class="font-medium text-gray-800">{{ item.name }}</p>
                                {% if item.description %}
                                <p class="text-sm text-gray-600">{{ item.description }}</p>
                                {% endif %}
                            </div>
                            <p class="font-medium text-gray-800">{{ item.price }}€</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-600">No treatments selected.</p>
                    {% endif %}
                </div>
                
                {% if promo_code %}
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Applied Promo Code</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="promo-badge mr-3">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    {{ promo_code }}
                                </div>
                                <span class="text-green-600 font-medium">You save {{ discount_amount }}€</span>
                            </div>
                            <button onclick="window.location.href='/quote-builder/promo-code'" class="text-sm text-blue-600 hover:underline">Change</button>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Your Information</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Name</p>
                                <p class="font-medium text-gray-800">{{ patient_info.first_name }} {{ patient_info.last_name }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="font-medium text-gray-800">{{ patient_info.email }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Phone</p>
                                <p class="font-medium text-gray-800">{{ patient_info.phone }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Country</p>
                                <p class="font-medium text-gray-800">{{ patient_info.country }}</p>
                            </div>
                            {% if patient_info.travel_date %}
                            <div>
                                <p class="text-sm text-gray-600">Travel Date</p>
                                <p class="font-medium text-gray-800">{{ patient_info.travel_date }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% if patient_info.additional_info %}
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">Additional Information</p>
                            <p class="font-medium text-gray-800">{{ patient_info.additional_info }}</p>
                        </div>
                        {% endif %}
                        <div class="mt-4 text-right">
                            <button onclick="window.location.href='/quote-builder/patient-info'" class="text-sm text-blue-600 hover:underline">Edit Information</button>
                        </div>
                    </div>
                </div>
                
                <div class="quote-summary">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Quote Summary</h3>
                    <div class="space-y-2 mb-4">
                        {% for item in quote_items %}
                        <div class="flex justify-between">
                            <span>{{ item.name }}</span>
                            <span>{{ item.price }}€</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if discount_amount and discount_amount > 0 %}
                    <div class="flex justify-between text-green-600 font-medium border-t border-b border-gray-200 py-2 my-2">
                        <span>Promo Discount</span>
                        <span>-{{ discount_amount }}€</span>
                    </div>
                    {% endif %}
                    
                    <div class="flex justify-between font-bold text-lg mt-2">
                        <span>Total</span>
                        <span class="summary-total">{{ total_price }}€</span>
                    </div>
                    
                    {% if discount_amount and discount_amount > 0 %}
                    <div class="text-right summary-savings mt-1">You save {{ discount_amount }}€</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex justify-between">
                <button onclick="window.location.href='/quote-builder/patient-info'" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Back</button>
                <button id="submit-quote" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Submit Quote</button>
            </div>
        </div>
        
        {% elif step == 'confirmation' %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="mb-6">
                <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Quote Submitted Successfully!</h2>
                <p class="text-gray-600 mb-8">Your quote request has been received. We'll review it and get back to you shortly.</p>
                
                <div class="bg-blue-50 rounded-lg p-4 mb-8 text-left max-w-lg mx-auto">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">What happens next?</h3>
                    <ol class="space-y-2 text-blue-800 list-decimal list-inside">
                        <li>Our dental experts will review your quote request</li>
                        <li>We'll match you with the best clinics for your needs</li>
                        <li>You'll receive a detailed quote within 24 hours</li>
                        <li>A personal coordinator will contact you to discuss your options</li>
                    </ol>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Quote Reference</h3>
                    <p class="text-xl font-bold text-blue-600">{{ quote_reference }}</p>
                    <p class="text-sm text-gray-600 mt-1">Please save this reference for future communications.</p>
                </div>
                
                <div class="space-y-4">
                    <p class="text-gray-800">We've also sent a confirmation email to <span class="font-semibold">{{ patient_info.email }}</span> with all the details.</p>
                    <p class="text-gray-600">If you have any questions, please contact us at <a href="mailto:support@mydentalfly.com" class="text-blue-600 hover:underline">support@mydentalfly.com</a> or call +90 123 456 7890.</p>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="/" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-md font-medium transition duration-300">Return to Homepage</a>
                <a href="/quote-builder" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-6 py-2 rounded-md font-medium transition duration-300">Create Another Quote</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners for various interactions
        setupTreatmentSelection();
        setupPromoCodeValidation();
        setupNavigationButtons();
        setupFormValidation();
        
        // Check for URL parameters to pre-populate fields
        checkUrlParameters();
        
        // Initialize synchronization with React application
        initReactSync();
    });
    
    function setupTreatmentSelection() {
        const treatmentCards = document.querySelectorAll('.treatment-card');
        treatmentCards.forEach(card => {
            card.addEventListener('click', function() {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('selected', checkbox.checked);
                
                // Optionally trigger a custom event to let other components know
                const event = new CustomEvent('treatment-selection-changed', {
                    detail: { id: this.dataset.id, selected: checkbox.checked }
                });
                document.dispatchEvent(event);
            });
        });
    }
    
    function setupPromoCodeValidation() {
        const promoForm = document.getElementById('promo-form');
        if (promoForm) {
            promoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const promoCode = document.getElementById('promo-code').value;
                
                // Here you would normally make an AJAX call to validate the promo code
                // For now, we'll just simulate the request
                validatePromoCode(promoCode);
            });
        }
    }
    
    function validatePromoCode(code) {
        // In a real application, this would be an API call
        // For demonstration, we're just refreshing the page with a parameter
        window.location.href = '/quote-builder/promo-code?code=' + encodeURIComponent(code) + '&validate=true';
    }
    
    function setupNavigationButtons() {
        const nextStepBtn = document.getElementById('next-step');
        if (nextStepBtn) {
            nextStepBtn.addEventListener('click', function() {
                // Determine which form needs to be validated
                const patientInfoForm = document.getElementById('patient-info-form');
                
                if (patientInfoForm && window.location.pathname.includes('patient-info')) {
                    // Validate patient info form before proceeding
                    if (patientInfoForm.checkValidity()) {
                        patientInfoForm.submit();
                    } else {
                        // Trigger browser's form validation UI
                        patientInfoForm.reportValidity();
                    }
                } else {
                    // For other steps, just navigate
                    navigateToNextStep();
                }
            });
        }
        
        const submitQuoteBtn = document.getElementById('submit-quote');
        if (submitQuoteBtn) {
            submitQuoteBtn.addEventListener('click', function() {
                // Submit the quote and navigate to confirmation
                window.location.href = '/quote-builder/confirmation';
            });
        }
    }
    
    function navigateToNextStep() {
        // This function determines the next step based on current URL
        const currentPath = window.location.pathname;
        let nextPath;
        
        if (currentPath.includes('dental-chart')) {
            nextPath = '/quote-builder/treatments';
        } else if (currentPath.includes('treatments')) {
            nextPath = '/quote-builder/promo-code';
        } else if (currentPath.includes('promo-code')) {
            nextPath = '/quote-builder/patient-info';
        } else if (currentPath.includes('patient-info')) {
            nextPath = '/quote-builder/review';
        }
        
        if (nextPath) {
            window.location.href = nextPath;
        }
    }
    
    function setupFormValidation() {
        // Add custom validation logic if needed
    }
    
    function checkUrlParameters() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Handle promo code from URL
        const promoCode = urlParams.get('promo');
        if (promoCode) {
            const promoInput = document.getElementById('promo-code');
            if (promoInput) {
                promoInput.value = promoCode;
                
                // Auto-validate the promo code if not already on the review page
                if (!window.location.pathname.includes('review')) {
                    validatePromoCode(promoCode);
                }
            }
        }
        
        // Handle special offer
        const offerId = urlParams.get('offer');
        if (offerId) {
            // Store this in local storage to persist during the quote flow
            localStorage.setItem('selectedOffer', offerId);
        }
        
        // Handle clinic ID
        const clinicId = urlParams.get('clinic');
        if (clinicId) {
            localStorage.setItem('selectedClinic', clinicId);
        }
    }
    
    function initReactSync() {
        // This function sets up communication with the React application
        // It sends the current quote state to React and listens for updates
        
        // Function to send data to React
        function syncWithReact() {
            // Create a message with the current state
            const currentState = {
                step: '{{ step }}',
                treatments: getSelectedTreatments(),
                promoCode: document.getElementById('promo-code')?.value || null,
                total: {{ total_price | default(0) }},
                discount: {{ discount_amount | default(0) }},
                clinicId: localStorage.getItem('selectedClinic')
            };
            
            // Send the message to the parent window (if in an iframe)
            window.parent.postMessage({
                type: 'QUOTE_BUILDER_SYNC',
                data: currentState
            }, '*');
            
            // Also try sending via localStorage for non-iframe scenarios
            try {
                localStorage.setItem('quoteBuilderState', JSON.stringify(currentState));
            } catch (e) {
                console.error('Error syncing quote state to localStorage:', e);
            }
        }
        
        function getSelectedTreatments() {
            const treatments = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                treatments.push(checkbox.value);
            });
            
            return treatments;
        }
        
        // Set up event listeners for changes
        document.addEventListener('treatment-selection-changed', syncWithReact);
        
        // Sync initially and periodically
        syncWithReact();
        setInterval(syncWithReact, 5000);
        
        // Listen for messages from React
        window.addEventListener('message', function(event) {
            if (event.data.type === 'REACT_QUOTE_SYNC') {
                // Apply updates from React if needed
                console.log('Received update from React:', event.data);
                
                // Handle specific updates
                if (event.data.data.promoCode && document.getElementById('promo-code')) {
                    document.getElementById('promo-code').value = event.data.data.promoCode;
                }
            }
        });
    }
</script>
{% endblock %}