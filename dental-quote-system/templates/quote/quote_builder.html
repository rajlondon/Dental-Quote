{% extends "base.html" %}

{% block title %}Build Your Dental Quote | MyDentalFly{% endblock %}

{% block extra_css %}
<style>
    .treatment-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .treatment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .selected-treatment {
        border: 2px solid var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 15px;
    }
    
    .quote-summary {
        position: sticky;
        top: 20px;
    }
    
    .quantity-control {
        width: 120px;
    }
    
    #promoCodeForm .input-group {
        width: 100%;
    }
    
    @media (max-width: 767.98px) {
        .quote-summary {
            position: static;
            margin-bottom: 30px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col">
            <h1 class="fw-bold">Build Your Dental Quote</h1>
            <p class="lead">Select treatments and customize your dental care package</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Quote Summary (Mobile - Top) -->
        <div class="col-12 d-block d-md-none mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Your Quote Summary</h5>
                </div>
                <div class="card-body">
                    {% include 'quote/partials/quote_summary.html' %}
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- Treatment Categories Tabs -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="treatmentTabs" role="tablist">
                        {% for category_id, category_data in categorized_treatments.items() %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if loop.first %}active{% endif %}" 
                                    id="{{ category_id }}-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#{{ category_id }}" 
                                    type="button" 
                                    role="tab" 
                                    aria-controls="{{ category_id }}" 
                                    aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                                <i class="fas fa-{{ category_data.category.icon }} me-2"></i>
                                {{ category_data.category.name }}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="treatmentTabsContent">
                        {% for category_id, category_data in categorized_treatments.items() %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                             id="{{ category_id }}" 
                             role="tabpanel" 
                             aria-labelledby="{{ category_id }}-tab">
                            <h4 class="mb-3">{{ category_data.category.name }}</h4>
                            <p class="text-muted mb-4">{{ category_data.category.description }}</p>
                            
                            <div class="row g-3">
                                {% for treatment in category_data.treatments %}
                                <div class="col-lg-6">
                                    <div class="card treatment-card h-100 {% if treatment.id in selected_treatments|map(attribute='id')|list %}selected-treatment{% endif %}" data-treatment-id="{{ treatment.id }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ treatment.name }}</h5>
                                            <p class="card-text">{{ treatment.description }}</p>
                                            <div class="d-flex justify-content-between align-items-center mt-3">
                                                <span class="fw-bold text-primary">${{ treatment.price }}</span>
                                                <form action="{{ url_for('add_treatment') }}" method="post" class="add-treatment-form">
                                                    <input type="hidden" name="treatment_id" value="{{ treatment.id }}">
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        {% if treatment.id in selected_treatments|map(attribute='id')|list %}
                                                            Already in Quote
                                                        {% else %}
                                                            Add to Quote
                                                        {% endif %}
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <div class="small text-muted mb-1"><i class="far fa-clock me-1"></i> Duration: {{ treatment.duration_days }} day(s)</div>
                                            <div class="small text-muted"><i class="far fa-calendar-alt me-1"></i> Recovery: {{ treatment.recovery_time }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quote Summary (Desktop - Sidebar) -->
        <div class="col-md-4 d-none d-md-block">
            <div class="quote-summary card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Your Quote Summary</h5>
                </div>
                <div class="card-body">
                    {% include 'quote/partials/quote_summary.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // AJAX for adding treatments
        document.querySelectorAll('.add-treatment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const treatmentId = formData.get('treatment_id');
                
                fetch('{{ url_for("add_treatment") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the button text
                        this.querySelector('button').textContent = 'Already in Quote';
                        
                        // Mark the card as selected
                        document.querySelector(`.treatment-card[data-treatment-id="${treatmentId}"]`).classList.add('selected-treatment');
                        
                        // Update the quote summary
                        updateQuoteSummary(data);
                    }
                });
            });
        });
        
        // AJAX for removing treatments
        document.querySelectorAll('.remove-treatment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const treatmentId = this.getAttribute('data-treatment-id');
                const formData = new FormData();
                formData.append('treatment_id', treatmentId);
                
                fetch('{{ url_for("remove_treatment") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the item from the selected treatments list
                        this.closest('.selected-treatment-item').remove();
                        
                        // Update the treatment card if visible
                        const card = document.querySelector(`.treatment-card[data-treatment-id="${treatmentId}"]`);
                        if (card) {
                            card.classList.remove('selected-treatment');
                            const button = card.querySelector('button');
                            if (button) {
                                button.textContent = 'Add to Quote';
                            }
                        }
                        
                        // Update the quote summary
                        updateQuoteSummary(data);
                    }
                });
            });
        });
        
        // AJAX for updating quantities
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const treatmentId = this.getAttribute('data-treatment-id');
                const quantity = this.value;
                const formData = new FormData();
                formData.append('treatment_id', treatmentId);
                formData.append('quantity', quantity);
                
                fetch('{{ url_for("update_quantity") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the quote summary
                        updateQuoteSummary(data);
                    }
                });
            });
        });
        
        // AJAX for applying promo code
        document.getElementById('promoCodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('{{ url_for("apply_promo_code") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const alertElement = document.getElementById('promoCodeAlert');
                
                if (data.success) {
                    // Update the promo code section
                    document.getElementById('promoCodeDisplay').textContent = data.promo_code;
                    document.getElementById('promoCodeSection').classList.remove('d-none');
                    document.getElementById('promoCodeForm').classList.add('d-none');
                    
                    // Show success message
                    alertElement.textContent = data.message;
                    alertElement.className = 'alert alert-success';
                    alertElement.classList.remove('d-none');
                    
                    // Update pricing
                    document.getElementById('subtotalValue').textContent = `$${data.subtotal.toFixed(2)}`;
                    document.getElementById('discountValue').textContent = `-$${data.discount.toFixed(2)}`;
                    document.getElementById('totalValue').textContent = `$${data.total.toFixed(2)}`;
                    
                    // Show the discount row
                    document.getElementById('discountRow').classList.remove('d-none');
                } else {
                    // Show error message
                    alertElement.textContent = data.message;
                    alertElement.className = 'alert alert-danger';
                    alertElement.classList.remove('d-none');
                }
                
                // Auto-hide the alert after 5 seconds
                setTimeout(() => {
                    alertElement.classList.add('d-none');
                }, 5000);
            });
        });
        
        // AJAX for removing promo code
        document.getElementById('removePromoBtn').addEventListener('click', function() {
            fetch('{{ url_for("remove_promo_code") }}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide promo code section and show the form
                    document.getElementById('promoCodeSection').classList.add('d-none');
                    document.getElementById('promoCodeForm').classList.remove('d-none');
                    
                    // Update pricing
                    document.getElementById('subtotalValue').textContent = `$${data.subtotal.toFixed(2)}`;
                    document.getElementById('totalValue').textContent = `$${data.total.toFixed(2)}`;
                    
                    // Hide the discount row if no discount
                    if (data.discount === 0) {
                        document.getElementById('discountRow').classList.add('d-none');
                    } else {
                        document.getElementById('discountValue').textContent = `-$${data.discount.toFixed(2)}`;
                    }
                    
                    // Clear the promo code input
                    document.getElementById('promoCodeInput').value = '';
                }
            });
        });
        
        // Function to update the quote summary
        function updateQuoteSummary(data) {
            const selectedTreatmentsList = document.getElementById('selectedTreatmentsList');
            
            // Clear the list
            selectedTreatmentsList.innerHTML = '';
            
            // Add treatments to the list
            if (data.selected_treatments && data.selected_treatments.length > 0) {
                data.selected_treatments.forEach(treatment => {
                    const item = document.createElement('div');
                    item.className = 'selected-treatment-item d-flex justify-content-between align-items-center mb-3';
                    item.innerHTML = `
                        <div>
                            <h6 class="mb-0">${treatment.name}</h6>
                            <span class="text-muted small">$${treatment.price} each</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="input-group input-group-sm quantity-control me-2">
                                <input type="number" class="form-control quantity-input" value="${treatment.quantity}" min="1" 
                                       data-treatment-id="${treatment.id}">
                            </div>
                            <button class="btn btn-sm btn-outline-danger remove-treatment-btn" 
                                    data-treatment-id="${treatment.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    selectedTreatmentsList.appendChild(item);
                    
                    // Reattach event listeners
                    const quantityInput = item.querySelector('.quantity-input');
                    quantityInput.addEventListener('change', function() {
                        const treatmentId = this.getAttribute('data-treatment-id');
                        const quantity = this.value;
                        const formData = new FormData();
                        formData.append('treatment_id', treatmentId);
                        formData.append('quantity', quantity);
                        
                        fetch('{{ url_for("update_quantity") }}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateQuoteSummary(data);
                            }
                        });
                    });
                    
                    const removeBtn = item.querySelector('.remove-treatment-btn');
                    removeBtn.addEventListener('click', function() {
                        const treatmentId = this.getAttribute('data-treatment-id');
                        const formData = new FormData();
                        formData.append('treatment_id', treatmentId);
                        
                        fetch('{{ url_for("remove_treatment") }}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove the item from the selected treatments list
                                this.closest('.selected-treatment-item').remove();
                                
                                // Update the treatment card if visible
                                const card = document.querySelector(`.treatment-card[data-treatment-id="${treatmentId}"]`);
                                if (card) {
                                    card.classList.remove('selected-treatment');
                                    const button = card.querySelector('button');
                                    if (button) {
                                        button.textContent = 'Add to Quote';
                                    }
                                }
                                
                                // Update the quote summary
                                updateQuoteSummary(data);
                            }
                        });
                    });
                });
                
                // Show the no treatments message if list is empty
                document.getElementById('noTreatmentsMessage').classList.add('d-none');
                
                // Enable the continue button
                document.getElementById('continueBtn').disabled = false;
            } else {
                // Show the no treatments message
                document.getElementById('noTreatmentsMessage').classList.remove('d-none');
                
                // Disable the continue button
                document.getElementById('continueBtn').disabled = true;
            }
            
            // Update pricing
            document.getElementById('subtotalValue').textContent = `$${data.subtotal.toFixed(2)}`;
            document.getElementById('totalValue').textContent = `$${data.total.toFixed(2)}`;
            
            // Update discount if applicable
            if (data.discount > 0) {
                document.getElementById('discountRow').classList.remove('d-none');
                document.getElementById('discountValue').textContent = `-$${data.discount.toFixed(2)}`;
            } else {
                document.getElementById('discountRow').classList.add('d-none');
            }
        }
    });
</script>
{% endblock %}