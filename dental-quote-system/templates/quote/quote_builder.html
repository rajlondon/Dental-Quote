{% extends "base.html" %}

{% block title %}Build Your Quote | MyDentalFly{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <h1 class="fw-bold mb-4">Build Your Dental Treatment Quote</h1>
            
            <!-- Treatment Selection -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Select Your Treatments</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <p>Browse treatments by category and add them to your quote. You can adjust quantities later.</p>
                    </div>
                    
                    <!-- Treatment Categories Tabs -->
                    <ul class="nav nav-tabs mb-4" id="treatmentTabs" role="tablist">
                        {% for category, treatments in categorized_treatments.items() %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link {% if loop.first %}active{% endif %}" 
                                        id="{{ category }}-tab" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#{{ category }}-content" 
                                        type="button" 
                                        role="tab" 
                                        aria-controls="{{ category }}-content" 
                                        aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                                    {{ category|replace('_', ' ')|title }}
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                    
                    <!-- Treatment Tabs Content -->
                    <div class="tab-content" id="treatmentTabsContent">
                        {% for category, treatments in categorized_treatments.items() %}
                            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                                id="{{ category }}-content" 
                                role="tabpanel" 
                                aria-labelledby="{{ category }}-tab">
                                
                                <div class="row g-3">
                                    {% for treatment in treatments %}
                                        <div class="col-md-6">
                                            <div class="card h-100 treatment-card">
                                                <div class="row g-0">
                                                    <div class="col-4">
                                                        {% if treatment.image %}
                                                            <img src="{{ treatment.image }}" 
                                                                class="img-fluid rounded-start" 
                                                                alt="{{ treatment.name }}" 
                                                                style="height: 100%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="bg-secondary text-white d-flex align-items-center justify-content-center h-100 rounded-start">
                                                                <i class="fas fa-tooth fa-2x"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-8">
                                                        <div class="card-body p-3">
                                                            <h6 class="card-title fw-bold mb-1">{{ treatment.name }}</h6>
                                                            <p class="card-text small text-muted mb-2">{{ treatment.description|truncate(60) }}</p>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="fw-bold text-primary">${{ treatment.price_usd }}</span>
                                                                <form action="{{ url_for('add_treatment') }}" method="POST" class="add-treatment-form">
                                                                    <input type="hidden" name="treatment_id" value="{{ treatment.id }}">
                                                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                                                        <i class="fas fa-plus me-1"></i> Add
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Treatment Details -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Treatment Information</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="treatmentAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    About Dental Implants
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#treatmentAccordion">
                                <div class="accordion-body">
                                    <p>Dental implants are artificial tooth roots that provide a permanent base for fixed, replacement teeth. They're a popular and effective long-term solution for people who suffer from missing teeth, failing teeth, or chronic dental problems.</p>
                                    <div class="d-flex flex-wrap gap-3 text-center mb-3">
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Procedure Time</div>
                                            <div class="fw-bold">1-2 hours per implant</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Recovery Time</div>
                                            <div class="fw-bold">3-6 months</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Success Rate</div>
                                            <div class="fw-bold">95-98%</div>
                                        </div>
                                    </div>
                                    <p class="mb-0"><strong>What to expect:</strong> The implant process typically involves several stages: initial consultation, implant placement surgery, healing period, abutment placement, and finally crown attachment.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    About Veneers
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#treatmentAccordion">
                                <div class="accordion-body">
                                    <p>Dental veneers are thin, custom-made shells designed to cover the front surface of teeth to improve their appearance. They can be made from porcelain or resin composite materials.</p>
                                    <div class="d-flex flex-wrap gap-3 text-center mb-3">
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Procedure Time</div>
                                            <div class="fw-bold">1-2 hours</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Recovery Time</div>
                                            <div class="fw-bold">1-2 days</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Durability</div>
                                            <div class="fw-bold">10-15 years</div>
                                        </div>
                                    </div>
                                    <p class="mb-0"><strong>What to expect:</strong> The process usually requires three trips to the dentist – one for a consultation, the second to prepare the teeth and create impressions, and the third to apply the veneers.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    About Crowns
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#treatmentAccordion">
                                <div class="accordion-body">
                                    <p>A dental crown is a tooth-shaped "cap" that is placed over a tooth to cover it and restore its shape, size, strength, and improve its appearance. The crowns, when cemented into place, fully encase the entire visible portion of a tooth.</p>
                                    <div class="d-flex flex-wrap gap-3 text-center mb-3">
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Procedure Time</div>
                                            <div class="fw-bold">1-2 hours</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Recovery Time</div>
                                            <div class="fw-bold">1-2 days</div>
                                        </div>
                                        <div class="border rounded p-2 flex-grow-1">
                                            <div class="text-muted small">Durability</div>
                                            <div class="fw-bold">5-15 years</div>
                                        </div>
                                    </div>
                                    <p class="mb-0"><strong>What to expect:</strong> Typically requires two visits – first to examine and prepare the tooth, make an impression and place a temporary crown; second to place the permanent crown.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Quote Summary -->
            <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Your Quote Summary</h5>
                </div>
                <div class="card-body">
                    <div id="quote-summary">
                        {% include "quote/partials/quote_summary.html" %}
                    </div>
                    
                    {% if selected_treatments %}
                        <div class="d-grid gap-2 mt-3">
                            <a href="{{ url_for('patient_info') }}" class="btn btn-primary">
                                Continue to Patient Information
                            </a>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('quote_builder', reset=True) }}'">
                                Reset Quote
                            </button>
                        </div>
                    {% else %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i> Please select at least one treatment to continue.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add AJAX functionality to all treatment addition forms
        const addForms = document.querySelectorAll('.add-treatment-form');
        
        addForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                // Change button text to indicate loading
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                submitButton.disabled = true;
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the quote summary with the new data
                        const quoteSummary = document.getElementById('quote-summary');
                        
                        // Create a temporary container element
                        const tempContainer = document.createElement('div');
                        
                        // Set the HTML content (this will be used to extract the updated summary)
                        tempContainer.innerHTML = `
                            <div class="selected-treatments">
                                ${data.selected_treatments.map(treatment => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <div class="fw-medium">${treatment.name}</div>
                                            <div class="text-muted small">$${treatment.price_usd} × ${treatment.quantity}</div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold">$${(treatment.price_usd * treatment.quantity).toFixed(2)}</span>
                                            <div class="dropdown ms-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <form action="{{ url_for('update_quantity') }}" method="POST" class="update-quantity-form">
                                                            <input type="hidden" name="treatment_id" value="${treatment.id}">
                                                            <div class="d-flex align-items-center px-3 py-1">
                                                                <label for="quantity-${treatment.id}" class="me-2">Qty:</label>
                                                                <input type="number" class="form-control form-control-sm" id="quantity-${treatment.id}" name="quantity" value="${treatment.quantity}" min="1" style="width: 60px;">
                                                                <button type="submit" class="btn btn-sm btn-primary ms-2">Update</button>
                                                            </div>
                                                        </form>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form action="{{ url_for('remove_treatment') }}" method="POST" class="remove-treatment-form">
                                                            <input type="hidden" name="treatment_id" value="${treatment.id}">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="fas fa-trash-alt me-2"></i> Remove
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <hr>
                            <div id="promo-code-section">
                                ${data.promo_code ? `
                                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-bold">Promo Code: ${data.promo_code}</div>
                                            <div class="small">${data.promo_details ? data.promo_details.description : 'Discount applied'}</div>
                                        </div>
                                        <form action="{{ url_for('remove_promo_code') }}" method="POST" id="remove-promo-form">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                ` : `
                                    <form action="{{ url_for('apply_promo_code') }}" method="POST" id="promo-code-form" class="mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="promo_code" placeholder="Promo Code" required>
                                            <button class="btn btn-outline-primary" type="submit">Apply</button>
                                        </div>
                                    </form>
                                `}
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span class="fw-medium">$${data.subtotal.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Discount:</span>
                                <span class="fw-medium">-$${data.discount.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">Total:</span>
                                <span class="fw-bold text-primary">$${data.total.toFixed(2)}</span>
                            </div>
                        `;
                        
                        // Update the quote summary
                        quoteSummary.innerHTML = tempContainer.innerHTML;
                        
                        // Re-attach event listeners to forms in the updated summary
                        attachFormListeners();
                        
                        // Check if we need to show or hide the continue button
                        const continueButtonsContainer = document.querySelector('.d-grid.gap-2.mt-3');
                        const alertInfo = document.querySelector('.alert.alert-info.mt-3');
                        
                        if (data.selected_treatments.length > 0) {
                            if (!continueButtonsContainer) {
                                const newButtonsContainer = document.createElement('div');
                                newButtonsContainer.className = 'd-grid gap-2 mt-3';
                                newButtonsContainer.innerHTML = `
                                    <a href="{{ url_for('patient_info') }}" class="btn btn-primary">
                                        Continue to Patient Information
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('quote_builder', reset=True) }}'">
                                        Reset Quote
                                    </button>
                                `;
                                quoteSummary.parentNode.appendChild(newButtonsContainer);
                                
                                // Remove the info alert if it exists
                                if (alertInfo) {
                                    alertInfo.remove();
                                }
                            }
                        } else {
                            if (continueButtonsContainer) {
                                continueButtonsContainer.remove();
                                
                                // Add the info alert if it doesn't exist
                                if (!alertInfo) {
                                    const newAlertInfo = document.createElement('div');
                                    newAlertInfo.className = 'alert alert-info mt-3';
                                    newAlertInfo.innerHTML = '<i class="fas fa-info-circle me-2"></i> Please select at least one treatment to continue.';
                                    quoteSummary.parentNode.appendChild(newAlertInfo);
                                }
                            }
                        }
                        
                        // Change button to indicate success
                        submitButton.innerHTML = '<i class="fas fa-check"></i>';
                        submitButton.classList.remove('btn-outline-primary');
                        submitButton.classList.add('btn-success');
                        
                        // Reset button after a delay
                        setTimeout(() => {
                            submitButton.innerHTML = originalText;
                            submitButton.classList.remove('btn-success');
                            submitButton.classList.add('btn-outline-primary');
                            submitButton.disabled = false;
                        }, 1500);
                    } else {
                        // Show error
                        submitButton.innerHTML = '<i class="fas fa-times"></i>';
                        submitButton.classList.remove('btn-outline-primary');
                        submitButton.classList.add('btn-danger');
                        
                        // Reset button after a delay
                        setTimeout(() => {
                            submitButton.innerHTML = originalText;
                            submitButton.classList.remove('btn-danger');
                            submitButton.classList.add('btn-outline-primary');
                            submitButton.disabled = false;
                        }, 1500);
                        
                        console.error('Error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Reset button
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                });
            });
        });
        
        // Function to attach event listeners to forms in the quote summary
        function attachFormListeners() {
            // Attach listeners to quantity update forms
            const updateForms = document.querySelectorAll('.update-quantity-form');
            updateForms.forEach(form => {
                form.addEventListener('submit', handleFormSubmit);
            });
            
            // Attach listeners to remove treatment forms
            const removeForms = document.querySelectorAll('.remove-treatment-form');
            removeForms.forEach(form => {
                form.addEventListener('submit', handleFormSubmit);
            });
            
            // Attach listener to promo code form
            const promoForm = document.getElementById('promo-code-form');
            if (promoForm) {
                promoForm.addEventListener('submit', handleFormSubmit);
            }
            
            // Attach listener to remove promo code form
            const removePromoForm = document.getElementById('remove-promo-form');
            if (removePromoForm) {
                removePromoForm.addEventListener('submit', handleFormSubmit);
            }
        }
        
        // Generic form submission handler
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the quote summary (reusing the same update logic as above)
                    updateQuoteSummary(data);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Function to update the quote summary with new data
        function updateQuoteSummary(data) {
            const quoteSummary = document.getElementById('quote-summary');
            
            // Create a temporary container element
            const tempContainer = document.createElement('div');
            
            // Set the HTML content
            tempContainer.innerHTML = `
                <div class="selected-treatments">
                    ${data.selected_treatments.map(treatment => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="fw-medium">${treatment.name}</div>
                                <div class="text-muted small">$${treatment.price_usd} × ${treatment.quantity}</div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold">$${(treatment.price_usd * treatment.quantity).toFixed(2)}</span>
                                <div class="dropdown ms-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <form action="{{ url_for('update_quantity') }}" method="POST" class="update-quantity-form">
                                                <input type="hidden" name="treatment_id" value="${treatment.id}">
                                                <div class="d-flex align-items-center px-3 py-1">
                                                    <label for="quantity-${treatment.id}" class="me-2">Qty:</label>
                                                    <input type="number" class="form-control form-control-sm" id="quantity-${treatment.id}" name="quantity" value="${treatment.quantity}" min="1" style="width: 60px;">
                                                    <button type="submit" class="btn btn-sm btn-primary ms-2">Update</button>
                                                </div>
                                            </form>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form action="{{ url_for('remove_treatment') }}" method="POST" class="remove-treatment-form">
                                                <input type="hidden" name="treatment_id" value="${treatment.id}">
                                                <button type="submit" class="dropdown-item text-danger">
                                                    <i class="fas fa-trash-alt me-2"></i> Remove
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <hr>
                <div id="promo-code-section">
                    ${data.promo_code ? `
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">Promo Code: ${data.promo_code}</div>
                                <div class="small">${data.promo_details ? data.promo_details.description : 'Discount applied'}</div>
                            </div>
                            <form action="{{ url_for('remove_promo_code') }}" method="POST" id="remove-promo-form">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>
                    ` : `
                        <form action="{{ url_for('apply_promo_code') }}" method="POST" id="promo-code-form" class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" name="promo_code" placeholder="Promo Code" required>
                                <button class="btn btn-outline-primary" type="submit">Apply</button>
                            </div>
                        </form>
                    `}
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span class="fw-medium">$${data.subtotal.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Discount:</span>
                    <span class="fw-medium">-$${data.discount.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Total:</span>
                    <span class="fw-bold text-primary">$${data.total.toFixed(2)}</span>
                </div>
            `;
            
            // Update the quote summary
            quoteSummary.innerHTML = tempContainer.innerHTML;
            
            // Re-attach event listeners
            attachFormListeners();
            
            // Check if we need to show or hide the continue button
            const continueButtonsContainer = document.querySelector('.d-grid.gap-2.mt-3');
            const alertInfo = document.querySelector('.alert.alert-info.mt-3');
            
            if (data.selected_treatments.length > 0) {
                if (!continueButtonsContainer) {
                    const newButtonsContainer = document.createElement('div');
                    newButtonsContainer.className = 'd-grid gap-2 mt-3';
                    newButtonsContainer.innerHTML = `
                        <a href="{{ url_for('patient_info') }}" class="btn btn-primary">
                            Continue to Patient Information
                        </a>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('quote_builder', reset=True) }}'">
                            Reset Quote
                        </button>
                    `;
                    quoteSummary.parentNode.appendChild(newButtonsContainer);
                    
                    // Remove the info alert if it exists
                    if (alertInfo) {
                        alertInfo.remove();
                    }
                }
            } else {
                if (continueButtonsContainer) {
                    continueButtonsContainer.remove();
                    
                    // Add the info alert if it doesn't exist
                    if (!alertInfo) {
                        const newAlertInfo = document.createElement('div');
                        newAlertInfo.className = 'alert alert-info mt-3';
                        newAlertInfo.innerHTML = '<i class="fas fa-info-circle me-2"></i> Please select at least one treatment to continue.';
                        quoteSummary.parentNode.appendChild(newAlertInfo);
                    }
                }
            }
        }
        
        // Initial attachment of event listeners
        attachFormListeners();
    });
</script>
{% endblock %}