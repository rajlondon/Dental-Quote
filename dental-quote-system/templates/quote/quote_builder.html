{% extends 'base.html' %}

{% block title %}MyDentalFly - Quote Builder{% endblock %}

{% block content %}
<div class="quote-builder">
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-4">Build Your Dental Treatment Quote</h1>
            <p class="lead mb-4">Select treatments from the categories below to build your personalized quote for dental treatment in Turkey.</p>
            
            <!-- Treatment Categories -->
            <div class="treatment-categories">
                {% for category in categories %}
                <div class="treatment-category" id="category-{{ category }}">
                    <h2 class="category-title text-capitalize">{{ category }}</h2>
                    <div class="row g-4">
                        {% for treatment in categorized_treatments[category] %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card treatment-card h-100">
                                <img src="{{ treatment.image }}" class="card-img-top" alt="{{ treatment.name }}">
                                <div class="card-body">
                                    <h3 class="card-title h5">{{ treatment.name }}</h3>
                                    <p class="card-text small">{{ treatment.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="card-price">${{ treatment.price }}</span>
                                        <form action="{{ url_for('page_routes.quote_builder') }}" method="POST" class="ajax-form">
                                            <input type="hidden" name="treatment_id" value="{{ treatment.id }}">
                                            <input type="hidden" name="action" value="add">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Add to Quote</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="selected-treatments">
                <h3 class="mb-3">Your Quote Summary</h3>
                
                {% if selected_treatments %}
                <div class="selected-treatments-list mb-4">
                    {% for treatment in selected_treatments %}
                    <div class="selected-treatment-item">
                        <div>
                            <div class="treatment-name">{{ treatment.name }}</div>
                            <div class="d-flex align-items-center mt-1">
                                <form id="update-form-{{ treatment.id }}" action="{{ url_for('page_routes.quote_builder') }}" method="POST" class="ajax-form d-flex align-items-center">
                                    <input type="hidden" name="treatment_id" value="{{ treatment.id }}">
                                    <input type="hidden" name="action" value="update_quantity">
                                    <div class="input-group input-group-sm" style="width: 100px;">
                                        <button type="button" class="btn btn-outline-secondary" onclick="updateQuantity('{{ treatment.id }}', -1)">-</button>
                                        <input type="number" id="quantity-{{ treatment.id }}" name="quantity" class="form-control text-center" value="{{ treatment.quantity|default(1) }}" min="1" max="10">
                                        <button type="button" class="btn btn-outline-secondary" onclick="updateQuantity('{{ treatment.id }}', 1)">+</button>
                                    </div>
                                </form>
                                <div class="ms-3">
                                    <form action="{{ url_for('page_routes.quote_builder') }}" method="POST" class="ajax-form">
                                        <input type="hidden" name="treatment_id" value="{{ treatment.id }}">
                                        <input type="hidden" name="action" value="remove">
                                        <button type="submit" class="btn btn-sm text-danger" title="Remove">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="treatment-price">${{ (treatment.price * treatment.quantity|default(1))|round(2) }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Promo Code Form -->
                <div class="promo-code-form">
                    <h4 class="mb-2">Have a Promo Code?</h4>
                    <form id="promo-form" action="{{ url_for('promo_routes.apply_promo') }}" method="POST">
                        <div class="input-group mb-2">
                            <input type="text" name="promo_code" class="form-control" placeholder="Enter code" {% if promo_code %}value="{{ promo_code }}"{% endif %}>
                            <button type="submit" class="btn btn-primary">Apply</button>
                        </div>
                    </form>
                    
                    <!-- Promo Details (shown when a promo is applied) -->
                    <div id="promo-details" class="alert alert-success p-2 mb-3 {% if not promo_code %}d-none{% endif %}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Applied:</strong> <span id="applied-promo-code">{{ promo_code }}</span>
                            </div>
                            <button id="remove-promo-btn" class="btn btn-sm btn-outline-danger" data-url="{{ url_for('promo_routes.remove_promo') }}" {% if not promo_code %}style="display: none;"{% endif %}>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quote Totals -->
                <div class="quote-totals">
                    <div class="total-line">
                        <span>Subtotal:</span>
                        <span id="subtotal-amount">${{ totals.subtotal|round(2) }}</span>
                    </div>
                    <div class="total-line {% if totals.discount <= 0 %}d-none{% endif %}">
                        <span>Discount:</span>
                        <span id="discount-amount" class="text-success">-${{ totals.discount|round(2) }}</span>
                    </div>
                    <div class="total-line final">
                        <span>Total:</span>
                        <span id="total-amount">${{ totals.total|round(2) }}</span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="mt-4">
                    <a href="{{ url_for('page_routes.patient_info') }}" class="btn btn-primary w-100">
                        Continue to Patient Info
                    </a>
                    <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="window.location.href='{{ url_for('page_routes.restart_quote') }}'">
                        Start Over
                    </button>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p>Your quote is empty. Please select treatments to include in your quote.</p>
                </div>
                <div class="text-center mt-4">
                    <a href="#category-{{ categories[0] }}" class="btn btn-primary">
                        Browse Treatments
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Smooth scroll to treatment categories
        const categoryLinks = document.querySelectorAll('a[href^="#category-"]');
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            });
        });
    });
</script>
{% endblock %}