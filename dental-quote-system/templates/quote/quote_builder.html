{% extends 'base.html' %}

{% block title %}Build Your Dental Quote - MyDentalFly{% endblock %}

{% block content %}
<!-- Quote Builder Header -->
<section class="quote-builder-header py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="fw-bold text-primary mb-2">Build Your Dental Quote</h1>
                <p class="lead">Select the treatments you're interested in to build your personalized quote</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="progress-container">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">Step 1 of 4: Select Treatments</small>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Quote Builder Content -->
<section class="quote-builder-content py-5">
    <div class="container">
        <div class="row">
            <!-- Treatments Selection -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-4">Select Your Treatments</h2>
                        
                        <div class="accordion" id="treatmentCategories">
                            {% for category_id, category in categorized_treatments.items() %}
                                <div class="accordion-item border-0 mb-3 shadow-sm">
                                    <h2 class="accordion-header" id="heading{{ category_id }}">
                                        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ category_id }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ category_id }}">
                                            {{ category.name }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ category_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ category_id }}" data-bs-parent="#treatmentCategories">
                                        <div class="accordion-body">
                                            <p class="text-muted mb-3">{{ category.description }}</p>
                                            
                                            <div class="row g-3">
                                                {% for treatment in category.treatments %}
                                                    <div class="col-md-6">
                                                        <div class="card h-100 treatment-card" id="treatment-{{ treatment.id }}">
                                                            <div class="card-body">
                                                                <h5 class="card-title">{{ treatment.name }}</h5>
                                                                <p class="card-text">{{ treatment.description }}</p>
                                                                <p class="card-text"><strong>Price:</strong> ${{ treatment.price }}</p>
                                                                <button class="btn btn-primary add-treatment-btn" data-treatment-id="{{ treatment.id }}">Add to Quote</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quote Summary -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px; z-index: 10;">
                    <div class="card-header bg-primary text-white py-3">
                        <h3 class="h5 mb-0">Your Quote Summary</h3>
                    </div>
                    <div class="card-body p-4">
                        <div id="selected-treatments-container">
                            {% if selected_treatments %}
                                <div class="selected-treatments mb-4">
                                    <h4 class="h6 mb-3">Selected Treatments</h4>
                                    <ul class="list-group list-group-flush" id="selected-treatments-list">
                                        {% for treatment in selected_treatments %}
                                            <li class="list-group-item px-0 py-2 border-bottom" data-treatment-id="{{ treatment.id }}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h5 class="h6 mb-1">{{ treatment.name }}</h5>
                                                        <div class="d-flex align-items-center quantity-control">
                                                            <button class="btn btn-sm btn-outline-secondary decrease-quantity" data-treatment-id="{{ treatment.id }}">-</button>
                                                            <span class="quantity mx-2">{{ treatment.quantity }}</span>
                                                            <button class="btn btn-sm btn-outline-secondary increase-quantity" data-treatment-id="{{ treatment.id }}">+</button>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fw-bold">${{ treatment.price * treatment.quantity }}</div>
                                                        <button class="btn btn-sm text-danger remove-treatment" data-treatment-id="{{ treatment.id }}">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% else %}
                                <div class="empty-quote text-center py-4">
                                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                    <h4 class="h6">Your quote is empty</h4>
                                    <p class="text-muted small">Select treatments to build your quote</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Promo Code Section -->
                        <div class="promo-code-section mb-4">
                            <h4 class="h6 mb-3">Promo Code</h4>
                            {% if promo_code %}
                                <div class="applied-promo alert alert-success mb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ promo_code }}</strong> applied
                                        </div>
                                        <button class="btn btn-sm btn-link text-danger p-0" id="remove-promo-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="input-group">
                                    <input type="text" class="form-control" id="promo-code-input" placeholder="Enter promo code">
                                    <button class="btn btn-outline-primary" type="button" id="apply-promo-btn">Apply</button>
                                </div>
                                <div id="promo-message" class="mt-2 small"></div>
                            {% endif %}
                        </div>
                        
                        <!-- Quote Totals -->
                        <div class="quote-totals">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span class="subtotal">${{ quote_totals.subtotal }}</span>
                            </div>
                            
                            {% if quote_totals.discount_amount > 0 %}
                                <div class="d-flex justify-content-between mb-2 text-success">
                                    <span>Discount:</span>
                                    <span class="discount">-${{ quote_totals.discount_amount }}</span>
                                </div>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between fw-bold mb-3">
                                <span>Total:</span>
                                <span class="total">${{ quote_totals.total }}</span>
                            </div>
                        </div>
                        
                        <!-- CTA Button -->
                        <a href="{{ url_for('page_routes.patient_info') }}" class="btn btn-primary w-100 {% if not selected_treatments %}disabled{% endif %}" id="continue-btn">
                            Continue to Patient Information
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    .treatment-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0,0,0,0.08);
    }
    
    .treatment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
    }
    
    .selected-treatment {
        border-left: 3px solid #0d6efd;
    }
    
    .sticky-top {
        top: 20px;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
    
    .quantity-control {
        max-width: 120px;
    }
    
    .treatment-selected {
        background-color: rgba(13, 110, 253, 0.1);
        border: 1px solid #0d6efd;
    }
    
    .treatment-selected .btn-primary {
        background-color: #198754;
        border-color: #198754;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Mark selected treatments
        function markSelectedTreatments() {
            $('.treatment-card').removeClass('treatment-selected');
            $('#selected-treatments-list li').each(function() {
                const treatmentId = $(this).data('treatment-id');
                $(`#treatment-${treatmentId}`).addClass('treatment-selected');
                $(`#treatment-${treatmentId} .add-treatment-btn`).text('Added to Quote');
            });
        }
        
        // Initialize - mark already selected treatments
        markSelectedTreatments();
        
        // Add treatment to quote
        $('.add-treatment-btn').click(function() {
            const treatmentId = $(this).data('treatment-id');
            
            // Check if treatment is already in the quote
            if ($(`#selected-treatments-list li[data-treatment-id="${treatmentId}"]`).length > 0) {
                // Treatment already in quote, just increase quantity
                $(`#selected-treatments-list li[data-treatment-id="${treatmentId}"] .increase-quantity`).click();
                return;
            }
            
            // Add loading indicator
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...');
            
            // Make AJAX request to add treatment
            $.ajax({
                url: '/api/add-treatment',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ treatment_id: treatmentId }),
                success: function(response) {
                    // Update the selected treatments list
                    updateSelectedTreatmentsAndTotals(response);
                    
                    // Enable continue button
                    $('#continue-btn').removeClass('disabled');
                },
                error: function(xhr) {
                    console.error('Error adding treatment:', xhr.responseText);
                    
                    // Reset button
                    $(`.add-treatment-btn[data-treatment-id="${treatmentId}"]`).text('Add to Quote');
                }
            });
        });
        
        // Event delegation for dynamically added elements
        $(document).on('click', '.remove-treatment', function() {
            const treatmentId = $(this).data('treatment-id');
            
            // Make AJAX request to remove treatment
            $.ajax({
                url: '/api/remove-treatment',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ treatment_id: treatmentId }),
                success: function(response) {
                    // Update the selected treatments list
                    updateSelectedTreatmentsAndTotals(response);
                    
                    // Update the add button text
                    $(`#treatment-${treatmentId} .add-treatment-btn`).text('Add to Quote');
                    $(`#treatment-${treatmentId}`).removeClass('treatment-selected');
                    
                    // Disable continue button if no treatments selected
                    if (response.selected_treatments.length === 0) {
                        $('#continue-btn').addClass('disabled');
                    }
                },
                error: function(xhr) {
                    console.error('Error removing treatment:', xhr.responseText);
                }
            });
        });
        
        // Increase quantity
        $(document).on('click', '.increase-quantity', function() {
            const treatmentId = $(this).data('treatment-id');
            const quantityElement = $(this).siblings('.quantity');
            const currentQuantity = parseInt(quantityElement.text());
            const newQuantity = currentQuantity + 1;
            
            updateTreatmentQuantity(treatmentId, newQuantity);
        });
        
        // Decrease quantity
        $(document).on('click', '.decrease-quantity', function() {
            const treatmentId = $(this).data('treatment-id');
            const quantityElement = $(this).siblings('.quantity');
            const currentQuantity = parseInt(quantityElement.text());
            
            if (currentQuantity > 1) {
                const newQuantity = currentQuantity - 1;
                updateTreatmentQuantity(treatmentId, newQuantity);
            } else {
                // If quantity would be 0, remove the treatment
                $(this).closest('li').find('.remove-treatment').click();
            }
        });
        
        // Apply promo code
        $('#apply-promo-btn').click(function() {
            const promoCode = $('#promo-code-input').val().trim();
            
            if (promoCode === '') {
                $('#promo-message').html('<span class="text-danger">Please enter a promo code</span>');
                return;
            }
            
            // Check if there are treatments in the quote
            if ($('#selected-treatments-list li').length === 0) {
                $('#promo-message').html('<span class="text-danger">Please add at least one treatment before applying a promo code</span>');
                return;
            }
            
            // Apply loading indicator
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            
            // Make AJAX request to apply promo code
            $.ajax({
                url: '/api/apply-promo-code',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ promo_code: promoCode }),
                success: function(response) {
                    // Refresh the page to update everything
                    location.reload();
                },
                error: function(xhr) {
                    // Reset button
                    $('#apply-promo-btn').text('Apply');
                    
                    // Parse error message
                    try {
                        const error = JSON.parse(xhr.responseText);
                        $('#promo-message').html(`<span class="text-danger">${error.message}</span>`);
                    } catch (e) {
                        $('#promo-message').html('<span class="text-danger">Invalid or expired promo code</span>');
                    }
                }
            });
        });
        
        // Remove promo code
        $('#remove-promo-btn').click(function() {
            // Make AJAX request to remove promo code
            $.ajax({
                url: '/api/remove-promo-code',
                type: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    // Refresh the page to update everything
                    location.reload();
                },
                error: function(xhr) {
                    console.error('Error removing promo code:', xhr.responseText);
                }
            });
        });
        
        // Helper function to update treatment quantity
        function updateTreatmentQuantity(treatmentId, quantity) {
            // Make AJAX request to update quantity
            $.ajax({
                url: '/api/update-treatment-quantity',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    treatment_id: treatmentId,
                    quantity: quantity
                }),
                success: function(response) {
                    // Update the selected treatments list
                    updateSelectedTreatmentsAndTotals(response);
                },
                error: function(xhr) {
                    console.error('Error updating quantity:', xhr.responseText);
                }
            });
        }
        
        // Helper function to update the UI with selected treatments and totals
        function updateSelectedTreatmentsAndTotals(response) {
            // Clear the current list
            $('#selected-treatments-list').empty();
            
            // Check if we have treatments
            if (response.selected_treatments.length === 0) {
                $('#selected-treatments-container').html(`
                    <div class="empty-quote text-center py-4">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h4 class="h6">Your quote is empty</h4>
                        <p class="text-muted small">Select treatments to build your quote</p>
                    </div>
                `);
            } else {
                // If previously empty, restore the structure
                if ($('#selected-treatments-container .empty-quote').length > 0) {
                    $('#selected-treatments-container').html(`
                        <div class="selected-treatments mb-4">
                            <h4 class="h6 mb-3">Selected Treatments</h4>
                            <ul class="list-group list-group-flush" id="selected-treatments-list"></ul>
                        </div>
                    `);
                }
                
                // Add each treatment to the list
                response.selected_treatments.forEach(function(treatment) {
                    $('#selected-treatments-list').append(`
                        <li class="list-group-item px-0 py-2 border-bottom" data-treatment-id="${treatment.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="h6 mb-1">${treatment.name}</h5>
                                    <div class="d-flex align-items-center quantity-control">
                                        <button class="btn btn-sm btn-outline-secondary decrease-quantity" data-treatment-id="${treatment.id}">-</button>
                                        <span class="quantity mx-2">${treatment.quantity}</span>
                                        <button class="btn btn-sm btn-outline-secondary increase-quantity" data-treatment-id="${treatment.id}">+</button>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">$${treatment.price * treatment.quantity}</div>
                                    <button class="btn btn-sm text-danger remove-treatment" data-treatment-id="${treatment.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    `);
                });
                
                // Mark selected treatments in the treatment list
                markSelectedTreatments();
            }
            
            // Update totals
            $('.subtotal').text('$' + response.totals.subtotal);
            
            if (response.totals.discount_amount > 0) {
                // Ensure discount row exists
                if ($('.discount').length === 0) {
                    $('.subtotal').parent().after(`
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Discount:</span>
                            <span class="discount">-$${response.totals.discount_amount}</span>
                        </div>
                    `);
                } else {
                    $('.discount').text('-$' + response.totals.discount_amount);
                }
            } else {
                // Remove discount row if it exists
                $('.discount').parent().remove();
            }
            
            $('.total').text('$' + response.totals.total);
        }
    });
</script>
{% endblock %}