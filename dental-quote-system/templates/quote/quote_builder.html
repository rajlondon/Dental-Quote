<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Quote Builder | MyDentalFly</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Dental Quote Builder</h1>
            <p>Create your personalized dental treatment quote</p>
            <nav>
                <a href="{{ url_for('page_routes.index') }}">Home</a> |
                <a href="{{ url_for('promo_routes.special_offers_page') }}">Special Offers</a>
            </nav>
        </header>

        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category|default('info') }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <section>
                <div class="card">
                    <div class="card-header">
                        <h2>Build Your Dental Quote</h2>
                        <p>Select the treatments you're interested in</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="step-indicator">
                            <div class="step active">1. Select Treatments</div>
                            <div class="step">2. Apply Promo</div>
                            <div class="step">3. Patient Info</div>
                            <div class="step">4. Review Quote</div>
                        </div>
                        
                        <!-- Treatments selection -->
                        <div class="treatment-cards">
                            {% for treatment in available_treatments %}
                                <div class="treatment-card {% if treatment.id in (treatments|map(attribute='id')|list) %}selected{% endif %}" 
                                     data-id="{{ treatment.id }}" 
                                     data-name="{{ treatment.name }}" 
                                     data-price="{{ treatment.price }}">
                                    <div class="treatment-name">{{ treatment.name }}</div>
                                    <div class="treatment-details">
                                        <span class="treatment-category">{{ treatment.category }}</span>
                                        <p class="treatment-description">{{ treatment.description }}</p>
                                        <div class="treatment-price">${{ treatment.price }}</div>
                                    </div>
                                    <div class="treatment-actions">
                                        <button type="button" class="btn btn-small {% if treatment.id in (treatments|map(attribute='id')|list) %}btn-success{% else %}btn-primary{% endif %}">
                                            {% if treatment.id in (treatments|map(attribute='id')|list) %}Selected{% else %}Select{% endif %}
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Promo code section -->
            <section class="promo-section">
                <h3>Apply Promo Code</h3>
                <form id="promo-form" class="promo-form">
                    <div class="form-group promo-input">
                        <input type="text" id="promo-code" name="promo_code" class="form-control" placeholder="Enter your promo code" value="{{ promo_code or '' }}">
                    </div>
                    <button type="submit" class="btn btn-primary">Apply</button>
                </form>
                <div id="promo-active-container">
                    {% if promo_details %}
                        <div class="promo-active">
                            <div class="promo-details">
                                <strong>Active Promo Code:</strong> <span>{{ promo_details.code }}</span>
                                <p>{{ "{}% Off".format(promo_details.value) if promo_details.type == 'percentage' else "${} Off".format(promo_details.value) }}</p>
                            </div>
                            <button type="button" class="promo-remove" id="remove-promo">Remove</button>
                        </div>
                    {% endif %}
                </div>
            </section>

            <!-- Quote summary -->
            <section>
                <div class="quote-summary" id="quote-summary">
                    <h3 class="quote-summary-title">Quote Summary</h3>
                    
                    <div id="selected-treatments-list">
                        {% for treatment in treatments %}
                            <div class="quote-summary-item">
                                <span class="quote-summary-label">{{ treatment.name }}</span>
                                <span class="quote-summary-value">${{ treatment.price }}</span>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="quote-summary-item">
                        <span class="quote-summary-label">Subtotal</span>
                        <span class="quote-summary-value" id="subtotal-value">${{ treatments|sum(attribute='price')|default(0) }}</span>
                    </div>
                    
                    {% if promo_details %}
                        <div class="quote-summary-item">
                            <span class="quote-summary-label">Discount ({{ promo_details.code }})</span>
                            <span class="quote-summary-value quote-discount" id="discount-value">
                                {% if promo_details.type == 'percentage' %}
                                    -${{ (treatments|sum(attribute='price')|default(0) * promo_details.value / 100)|round(2) }}
                                {% else %}
                                    -${{ [promo_details.value, treatments|sum(attribute='price')|default(0)]|min }}
                                {% endif %}
                            </span>
                        </div>
                    {% else %}
                        <div class="quote-summary-item">
                            <span class="quote-summary-label">Discount</span>
                            <span class="quote-summary-value" id="discount-value">$0.00</span>
                        </div>
                    {% endif %}
                    
                    <div class="quote-total">
                        <span class="quote-total-label">Total</span>
                        <span class="quote-total-value" id="total-value">
                            {% if promo_details %}
                                {% if promo_details.type == 'percentage' %}
                                    ${{ (treatments|sum(attribute='price')|default(0) * (1 - promo_details.value / 100))|round(2) }}
                                {% else %}
                                    ${{ [0, (treatments|sum(attribute='price')|default(0) - promo_details.value)]|max|round(2) }}
                                {% endif %}
                            {% else %}
                                ${{ treatments|sum(attribute='price')|default(0) }}
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="quote-actions">
                        <a href="{{ url_for('page_routes.reset_quote') }}" class="btn btn-outline">Reset Quote</a>
                        <a href="{{ url_for('page_routes.review_quote') }}" class="btn btn-primary">Proceed to Review</a>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Â© 2025 Dental Quote System | Powered by MyDentalFly</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>