{% extends 'base.html' %}

{% block title %}Build Your Dental Quote | MyDentalFly{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-light py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-3">Build Your Dental Quote</h1>
                <p class="lead">Select the treatments you're interested in and get an instant price estimate.</p>
                
                <!-- Progress Stepper -->
                <div class="stepper">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-label">Select Treatments</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-label">Patient Info</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">Review Quote</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-label">Confirmation</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Treatment Categories and Options -->
            <div class="col-lg-8">
                <div class="accordion" id="treatmentAccordion">
                    {% if categorized_treatments %}
                        {% for category_id, category in categorized_treatments.items() %}
                            <div class="accordion-item mb-3 shadow-sm">
                                <h2 class="accordion-header" id="heading{{ category_id }}">
                                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ category_id }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse{{ category_id }}">
                                        <span class="fw-bold">{{ category.name }}</span>
                                    </button>
                                </h2>
                                <div id="collapse{{ category_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ category_id }}" data-bs-parent="#treatmentAccordion">
                                    <div class="accordion-body">
                                        <p class="text-muted mb-4">{{ category.description }}</p>
                                        
                                        <div class="row g-4">
                                            {% if category.treatments %}
                                                {% for treatment in category.treatments %}
                                                    <div class="col-md-6">
                                                        <div class="card h-100">
                                                            <div class="card-body">
                                                                <h5 class="card-title">{{ treatment.name }}</h5>
                                                                <p class="card-text small">{{ treatment.description }}</p>
                                                                <p class="price">${{ treatment.price }}</p>
                                                                <p class="text-muted small mb-3">
                                                                    <span class="d-block">Treatment time: {{ treatment.duration_days }} days</span>
                                                                    <span class="d-block">Recovery: {{ treatment.recovery_time }}</span>
                                                                </p>
                                                                
                                                                <button type="button" 
                                                                    class="btn btn-sm btn-primary add-treatment-btn" 
                                                                    data-treatment-id="{{ treatment.id }}"
                                                                    data-treatment-name="{{ treatment.name }}"
                                                                    data-treatment-price="{{ treatment.price }}">
                                                                    Add to Quote
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="col-12">
                                                    <div class="alert alert-info">
                                                        No treatments available in this category.
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            No treatment categories available. Please check back later.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quote Summary -->
            <div class="col-lg-4">
                <div class="card shadow quote-summary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Your Quote Summary</h5>
                    </div>
                    <div class="card-body">
                        <!-- Selected Treatments -->
                        <div class="treatment-list mb-4">
                            <h6 class="fw-bold mb-3">Selected Treatments</h6>
                            
                            <div id="selected-treatments-list">
                                {% if selected_treatments %}
                                    {% for treatment in selected_treatments %}
                                        <div class="selected-treatment mb-3 border-bottom pb-2" data-treatment-id="{{ treatment.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-0">{{ treatment.name }}</h6>
                                                    <p class="text-muted small mb-0">${{ treatment.price }} each</p>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <div class="input-group input-group-sm quantity-control me-2" style="width: 100px;">
                                                        <button class="btn btn-outline-secondary decrease-quantity" type="button" data-treatment-id="{{ treatment.id }}">-</button>
                                                        <input type="number" class="form-control text-center treatment-quantity" value="{{ treatment.quantity }}" min="1" data-treatment-id="{{ treatment.id }}">
                                                        <button class="btn btn-outline-secondary increase-quantity" type="button" data-treatment-id="{{ treatment.id }}">+</button>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-treatment" data-treatment-id="{{ treatment.id }}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                                                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-info" id="no-treatments-message">
                                        <p class="mb-0">No treatments selected yet. Browse the categories and add treatments to your quote.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Promo Code Form -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Promo Code</h6>
                            
                            {% if promo_code %}
                                <div class="alert alert-success d-flex justify-content-between align-items-center" id="active-promo-container">
                                    <div>
                                        <p class="mb-0"><strong>{{ promo_code }}</strong> applied!</p>
                                    </div>
                                    <button type="button" id="remove-promo-btn" class="btn btn-sm btn-outline-danger">
                                        Remove
                                    </button>
                                </div>
                            {% else %}
                                <form id="promo-form" class="d-flex gap-2">
                                    <input type="text" class="form-control" id="promo-code" name="promo_code" placeholder="Enter promo code">
                                    <button type="submit" class="btn btn-outline-primary">Apply</button>
                                </form>
                                <div id="promo-message" class="mt-2"></div>
                            {% endif %}
                        </div>
                        
                        <!-- Price Summary -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Price Summary</h6>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotal">${{ subtotal }}</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2 {% if discount_amount == 0 %}d-none{% endif %}" id="discount-row">
                                <span>Discount:</span>
                                <span id="discount" class="text-success">-${{ discount_amount }}</span>
                            </div>
                            
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total:</span>
                                <span id="total">${{ total }}</span>
                            </div>
                        </div>
                        
                        <!-- Continue Button -->
                        <div class="text-center">
                            <a href="{{ url_for('page_routes.patient_info') }}" class="btn btn-primary btn-lg w-100" id="continue-btn" {% if not selected_treatments %}disabled{% endif %}>
                                Continue to Patient Info
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add treatment to quote
        document.querySelectorAll('.add-treatment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const treatmentId = this.dataset.treatmentId;
                const treatmentName = this.dataset.treatmentName;
                const treatmentPrice = this.dataset.treatmentPrice;
                
                addTreatment(treatmentId);
            });
        });
        
        // Handle quantity changes and treatment removal
        setupEventListeners();
        
        // Handle promo code form submission
        const promoForm = document.getElementById('promo-form');
        if (promoForm) {
            promoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                applyPromoCode();
            });
        }
        
        // Handle promo code removal
        const removePromoBtn = document.getElementById('remove-promo-btn');
        if (removePromoBtn) {
            removePromoBtn.addEventListener('click', function() {
                removePromoCode();
            });
        }
    });
    
    function setupEventListeners() {
        // Remove treatment
        document.querySelectorAll('.remove-treatment').forEach(button => {
            button.addEventListener('click', function() {
                const treatmentId = this.dataset.treatmentId;
                removeTreatment(treatmentId);
            });
        });
        
        // Increase quantity
        document.querySelectorAll('.increase-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const treatmentId = this.dataset.treatmentId;
                const input = document.querySelector(`.treatment-quantity[data-treatment-id="${treatmentId}"]`);
                input.value = parseInt(input.value) + 1;
                updateQuantity(treatmentId, parseInt(input.value));
            });
        });
        
        // Decrease quantity
        document.querySelectorAll('.decrease-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const treatmentId = this.dataset.treatmentId;
                const input = document.querySelector(`.treatment-quantity[data-treatment-id="${treatmentId}"]`);
                if (parseInt(input.value) > 1) {
                    input.value = parseInt(input.value) - 1;
                    updateQuantity(treatmentId, parseInt(input.value));
                }
            });
        });
        
        // Direct input change
        document.querySelectorAll('.treatment-quantity').forEach(input => {
            input.addEventListener('change', function() {
                const treatmentId = this.dataset.treatmentId;
                let value = parseInt(this.value);
                
                // Ensure the value is at least 1
                if (isNaN(value) || value < 1) {
                    value = 1;
                    this.value = value;
                }
                
                updateQuantity(treatmentId, value);
            });
        });
    }
    
    // Add treatment to quote via AJAX
    function addTreatment(treatmentId) {
        fetch('/api/add-treatment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ treatment_id: treatmentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQuoteSummary(data);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred. Please try again.', 'danger');
        });
    }
    
    // Remove treatment from quote via AJAX
    function removeTreatment(treatmentId) {
        fetch('/api/remove-treatment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ treatment_id: treatmentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQuoteSummary(data);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred. Please try again.', 'danger');
        });
    }
    
    // Update treatment quantity via AJAX
    function updateQuantity(treatmentId, quantity) {
        fetch('/api/update-quantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ 
                treatment_id: treatmentId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQuoteSummary(data);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred. Please try again.', 'danger');
        });
    }
    
    // Apply promo code via AJAX
    function applyPromoCode() {
        const promoCode = document.getElementById('promo-code').value;
        if (!promoCode) {
            showPromoMessage('Please enter a promo code.', 'danger');
            return;
        }
        
        const formData = new FormData();
        formData.append('promo_code', promoCode);
        
        fetch('/apply-promo', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to reflect the applied promo code
                window.location.reload();
            } else {
                showPromoMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showPromoMessage('An error occurred. Please try again.', 'danger');
        });
    }
    
    // Remove promo code via AJAX
    function removePromoCode() {
        fetch('/remove-promo', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to reflect the removed promo code
                window.location.reload();
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred. Please try again.', 'danger');
        });
    }
    
    // Update the quote summary with the new data
    function updateQuoteSummary(data) {
        const treatmentsList = document.getElementById('selected-treatments-list');
        const noTreatmentsMessage = document.getElementById('no-treatments-message');
        const subtotalElement = document.getElementById('subtotal');
        const discountElement = document.getElementById('discount');
        const discountRow = document.getElementById('discount-row');
        const totalElement = document.getElementById('total');
        const continueBtn = document.getElementById('continue-btn');
        
        // Update price information
        subtotalElement.textContent = '$' + data.subtotal.toFixed(2);
        
        if (data.discount_amount > 0) {
            discountElement.textContent = '-$' + data.discount_amount.toFixed(2);
            discountRow.classList.remove('d-none');
        } else {
            discountRow.classList.add('d-none');
        }
        
        totalElement.textContent = '$' + data.total.toFixed(2);
        
        // Update selected treatments list
        if (data.treatments && data.treatments.length > 0) {
            // Enable continue button
            continueBtn.removeAttribute('disabled');
            
            // Hide no treatments message if it exists
            if (noTreatmentsMessage) {
                noTreatmentsMessage.style.display = 'none';
            }
            
            // Clear current list
            treatmentsList.innerHTML = '';
            
            // Add each treatment to the list
            data.treatments.forEach(treatment => {
                const treatmentElement = document.createElement('div');
                treatmentElement.className = 'selected-treatment mb-3 border-bottom pb-2';
                treatmentElement.setAttribute('data-treatment-id', treatment.id);
                
                treatmentElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-0">${treatment.name}</h6>
                            <p class="text-muted small mb-0">$${treatment.price} each</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="input-group input-group-sm quantity-control me-2" style="width: 100px;">
                                <button class="btn btn-outline-secondary decrease-quantity" type="button" data-treatment-id="${treatment.id}">-</button>
                                <input type="number" class="form-control text-center treatment-quantity" value="${treatment.quantity}" min="1" data-treatment-id="${treatment.id}">
                                <button class="btn btn-outline-secondary increase-quantity" type="button" data-treatment-id="${treatment.id}">+</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-treatment" data-treatment-id="${treatment.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                treatmentsList.appendChild(treatmentElement);
            });
            
            // Re-attach event listeners
            setupEventListeners();
        } else {
            // Disable continue button
            continueBtn.setAttribute('disabled', 'disabled');
            
            // Show no treatments message
            treatmentsList.innerHTML = `
                <div class="alert alert-info" id="no-treatments-message">
                    <p class="mb-0">No treatments selected yet. Browse the categories and add treatments to your quote.</p>
                </div>
            `;
        }
    }
    
    // Show a message for the promo code form
    function showPromoMessage(message, type) {
        const promoMessage = document.getElementById('promo-message');
        promoMessage.innerHTML = `<div class="alert alert-${type} py-2 px-3 small">${message}</div>`;
        
        // Clear the message after 5 seconds
        setTimeout(() => {
            promoMessage.innerHTML = '';
        }, 5000);
    }
    
    // Show an alert message
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        const alertContainer = document.createElement('div');
        alertContainer.innerHTML = alertHtml;
        document.body.appendChild(alertContainer.firstChild);
        
        // Automatically dismiss after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                if (alert.querySelector('button.btn-close')) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 5000);
    }
</script>
{% endblock %}