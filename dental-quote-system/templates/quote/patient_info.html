{% extends "base.html" %}

{% block title %}Patient Information | MyDentalFly{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Patient Information Form Section -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body p-4">
                    <h2 class="card-title fw-bold mb-4">Patient Information</h2>
                    
                    <!-- Progress Indicator -->
                    <div class="progress mb-5" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 66%;" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between text-center mb-5">
                        <div>
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="small">Treatments</div>
                        </div>
                        <div>
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 30px; height: 30px;">
                                <span>2</span>
                            </div>
                            <div class="small fw-bold">Patient Info</div>
                        </div>
                        <div>
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 30px; height: 30px;">
                                <span>3</span>
                            </div>
                            <div class="small">Review</div>
                        </div>
                        <div>
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 30px; height: 30px;">
                                <span>4</span>
                            </div>
                            <div class="small">Confirmation</div>
                        </div>
                    </div>
                    
                    <!-- Patient Information Form -->
                    <form id="patientInfoForm" method="POST" action="{{ url_for('review_quote') }}">
                        <!-- Personal Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Personal Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="firstName" name="first_name" required value="{{ patient_info.first_name if patient_info else '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="lastName" name="last_name" required value="{{ patient_info.last_name if patient_info else '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email Address *</label>
                                        <input type="email" class="form-control" id="email" name="email" required value="{{ patient_info.email if patient_info else '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-control" id="phone" name="phone" required value="{{ patient_info.phone if patient_info else '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="country" class="form-label">Country *</label>
                                        <select class="form-select" id="country" name="country" required>
                                            <option value="" selected disabled>Select your country</option>
                                            {% for country in countries %}
                                            <option value="{{ country.code }}" {% if patient_info and patient_info.country == country.code %}selected{% endif %}>{{ country.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="city" name="city" value="{{ patient_info.city if patient_info else '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Travel Preferences -->
                        <div class="card mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Travel Preferences</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="preferredTravelDate" class="form-label">Preferred Travel Date</label>
                                        <input type="date" class="form-control" id="preferredTravelDate" name="preferred_travel_date" value="{{ patient_info.preferred_travel_date if patient_info else '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="travelFlexibility" class="form-label">Travel Flexibility</label>
                                        <select class="form-select" id="travelFlexibility" name="travel_flexibility">
                                            <option value="" selected disabled>Select your flexibility</option>
                                            <option value="very_flexible" {% if patient_info and patient_info.travel_flexibility == 'very_flexible' %}selected{% endif %}>Very Flexible (±3 months)</option>
                                            <option value="flexible" {% if patient_info and patient_info.travel_flexibility == 'flexible' %}selected{% endif %}>Flexible (±1 month)</option>
                                            <option value="somewhat_flexible" {% if patient_info and patient_info.travel_flexibility == 'somewhat_flexible' %}selected{% endif %}>Somewhat Flexible (±2 weeks)</option>
                                            <option value="specific_dates" {% if patient_info and patient_info.travel_flexibility == 'specific_dates' %}selected{% endif %}>Specific Dates Only</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="preferredClinic" class="form-label">Preferred Clinic (if any)</label>
                                        <select class="form-select" id="preferredClinic" name="preferred_clinic">
                                            <option value="" selected>No preference</option>
                                            {% for clinic in clinics %}
                                            <option value="{{ clinic.id }}" {% if patient_info and patient_info.preferred_clinic == clinic.id|string %}selected{% endif %}>{{ clinic.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label d-block">Traveling With Companion *</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="travel_with_companion" id="companionYes" value="yes" {% if patient_info and patient_info.travel_with_companion == 'yes' %}checked{% endif %} required>
                                            <label class="form-check-label" for="companionYes">Yes</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="travel_with_companion" id="companionNo" value="no" {% if patient_info and patient_info.travel_with_companion == 'no' %}checked{% endif %} required>
                                            <label class="form-check-label" for="companionNo">No</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Communication Preferences -->
                        <div class="card mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Communication Preferences</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="preferredContact" class="form-label">Preferred Contact Method</label>
                                        <select class="form-select" id="preferredContact" name="preferred_contact">
                                            <option value="" selected disabled>Select contact method</option>
                                            <option value="email" {% if patient_info and patient_info.preferred_contact == 'email' %}selected{% endif %}>Email</option>
                                            <option value="phone" {% if patient_info and patient_info.preferred_contact == 'phone' %}selected{% endif %}>Phone</option>
                                            <option value="whatsapp" {% if patient_info and patient_info.preferred_contact == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="preferredLanguage" class="form-label">Preferred Language</label>
                                        <select class="form-select" id="preferredLanguage" name="preferred_language">
                                            <option value="" selected disabled>Select language</option>
                                            <option value="english" {% if patient_info and patient_info.preferred_language == 'english' %}selected{% endif %}>English</option>
                                            <option value="german" {% if patient_info and patient_info.preferred_language == 'german' %}selected{% endif %}>German</option>
                                            <option value="french" {% if patient_info and patient_info.preferred_language == 'french' %}selected{% endif %}>French</option>
                                            <option value="spanish" {% if patient_info and patient_info.preferred_language == 'spanish' %}selected{% endif %}>Spanish</option>
                                            <option value="turkish" {% if patient_info and patient_info.preferred_language == 'turkish' %}selected{% endif %}>Turkish</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medical Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Medical Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="medicalConditions" class="form-label">Medical Conditions</label>
                                        <textarea class="form-control" id="medicalConditions" name="medical_conditions" rows="3" placeholder="Please list any relevant medical conditions, allergies, or medications">{{ patient_info.medical_conditions if patient_info else '' }}</textarea>
                                    </div>
                                    <div class="col-12">
                                        <label for="dentalHistory" class="form-label">Dental History/Concerns</label>
                                        <textarea class="form-control" id="dentalHistory" name="dental_history" rows="3" placeholder="Please describe your dental history and any specific concerns">{{ patient_info.dental_history if patient_info else '' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Additional Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="additionalNotes" class="form-label">Additional Notes</label>
                                        <textarea class="form-control" id="additionalNotes" name="additional_notes" rows="3" placeholder="Please provide any additional information or questions">{{ patient_info.additional_notes if patient_info else '' }}</textarea>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacy_consent" required {% if patient_info and patient_info.privacy_consent %}checked{% endif %}>
                                            <label class="form-check-label" for="privacyConsent">
                                                I consent to the processing of my personal data in accordance with the <a href="#" target="_blank">Privacy Policy</a> *
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="marketingConsent" name="marketing_consent" {% if patient_info and patient_info.marketing_consent %}checked{% endif %}>
                                            <label class="form-check-label" for="marketingConsent">
                                                I would like to receive promotional emails and offers about dental treatments and services
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('quote_builder') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Continue <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Privacy Information -->
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">Your Privacy Matters</h5>
                    <p class="text-muted mb-0">Your personal and medical information is securely stored and only shared with your selected dental clinic when you confirm your quote. We implement industry-standard encryption and security measures to protect your data. You can request the deletion of your information at any time by contacting our customer support team.</p>
                </div>
            </div>
        </div>
        
        <!-- Quote Summary Section -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="card-title mb-0">Quote Summary</h5>
                </div>
                <div class="card-body p-0">
                    {% include 'quote/partials/quote_summary.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const patientInfoForm = document.getElementById('patientInfoForm');
        
        patientInfoForm.addEventListener('submit', function(event) {
            // Basic form validation
            if (!patientInfoForm.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Find the first invalid input and scroll to it
                const firstInvalidInput = patientInfoForm.querySelector(':invalid');
                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                    
                    // Scroll to the first invalid input with smooth behavior
                    const parentCard = firstInvalidInput.closest('.card');
                    if (parentCard) {
                        parentCard.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
                
                return false;
            }
            
            return true;
        });
    });
</script>
{% endblock %}

{% block extra_css %}
.bg-opacity-10 {
    --bs-bg-opacity: 0.1;
}
.sticky-top {
    position: -webkit-sticky;
    position: sticky;
}
{% endblock %}